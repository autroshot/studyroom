# 6장 프락시

## 1. 웹 중개자

웹 프락시 서버는 클라이언트의 입장에서 트랜잭션을 수행하는 중개인이다.

HTTP 프락시 서버는 웹 서버이기도 하고 웹 클라이언트이기도 하다.

### 개인 프락시와 공유 프락시

- 개인 프락시: 하나의 클라이언트만을 위한 프락시. 개인 프락시는 클라이언트 컴퓨터에서 직접 실행되는 형태이다. 어떤 브라우저 보조 제품들은 브라우저의 기능을 확장하서나 성능을 개선하기 위해 작은 프락시를 사용자의 컴퓨터에서 직접 실행한다.
- 공유 프락시:  여러 클라이언트가 함께 사용하는 프락시는 공용 프락시. 대부분의 프락시는 공용이며 공유된 프락시다. 중앙 집중형 프락시를 관리하는 게 더 비용효율이 높고 쉽다.

### 프락시 대 게이트웨이

- 프락시: 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결한다.
- 게이트웨이: 서로 다른 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결한다. 프로토콜 변환기처럼 동작한다.

실질적으로 프락시와 게이트웨이의 차이점은 모호하다. 프락시는 때때로 약간의 프로토콜 변환을 하기도 한다.

## 2. 왜 프락시를 사용하는가?

프락시 서버는 모든 HTTP 트래픽을 들여다보고 건드릴 수 있기 때문에 무슨 일이든 할 수 있다.

- 어린이 필터: 성인 콘텐츠를 차단하려고 필터링 프락시를 사용할 수 있다.
- 문서 접근 제어자: 인터넷이나 웹 서버에 대한 접근 제어를 중앙 프락시 서버에서 관리한다.
- 보안 방화벽: 조직 안에 들어오거나 나가는 응용 레벨 프로토콜의 흐름을 네트워크의 한 지점에서 통제한다.
- 웹 캐시: 인기 있는 문서의 로컬 사본을 관리하여 느리고 비싼 인터넷 커뮤니케이션을 줄인다.
- 대리 프락시(Surrogate): 리버스 프락시 혹은 서버 가속기라고도 부른다. 공용 콘텐츠에 대한 느린 웹 서버의 성능을 개선하기 위해 사용할 수 있다.
- 콘텐츠 라우터: 인터넷 트래픽 조건과 콘텐츠의 종류에 따라 요청을 특정 웹 서버로 유도한다.
- 트랜스코더: 콘텐츠를 클라이언트에게 전달하기 전에 본문 포맷을 수정한다. 이미지의 크기를 줄이거나 문서를 번역하는 것이 가능하다.
- 익명화 프락시(Anonymizer): HTTP 메시지에서 신원을 식별할 수 있는 특성들(IP 주소, From 헤더, Referer 헤더, 쿠키, URI 세션 아이디 등)을 제거하여 개인 정보 보호와 익명성 보장에 기여한다.

## 3. 프락시는 어디에 있는가?

### 프락시 서버 배치

- 출구(Egress) 프락시: 로컬 네트워크와 인터넷 사이를 오가는 트래픽을 제어하기 위해 프락시를 로컬 네트워크의 출구에 놓는다. 방화벽, 필터링, 성능 개선의 목적으로 사용할 수 있다.
- 접근(입구) 프락시: 고객으로부터의 모든 요청을 종합적으로 처리하기 위해 프락시를 ISP 접근 지점에 놓는다. ISP는 사용자들의 다운로드 속도를 개선하고 비용을 줄이기 위해 캐시 프락시를 사용할 수 있다.
- 대리 프락시: 웹 서버들의 바로 앞에 위치하여 웹 서버로 향하는 모든 요청을 처리한다. 보안 기능이나 캐시 용도로 사용할 수 있다.
- 네트워크 교환 프락시: 네트워크 사이의 인터넷 피어링 교환 지점들에 놓는다. 캐시 용도로 쓰이거나 트래픽 흐름을 감시할 수 있다.

### 프락시 계층

프락시들은 프락시 계층이라고 불리는 연쇄를 구성할 수 있다. 프락시 계층에서 프락시 서버들은 부모와 자식의 관계를 갖는다. 다음번 인바운드 프락시(서버에 가까운 쪽)를 부모라고 부르고 다음번 아웃바운드 프락시(클라이언트에 가까운 쪽)는 자식이라고 부른다.

예를 들어 다음 계층에서 프락시 2는 프락시 1의 부모이자 프락시 3의 자식이다.

```
클라이언트 - 프락시1 - 프락시2 - 프락시3 - 서버
```

#### 프락시 계층 콘텐츠 라우팅

계층이 정적이어야 하는 것은 아니다. 프락시 서버는 메시지를 다양하고 유동적인 프락시 서버와 원 서버들의 집합에 보낼 수 있다. 접근 프락시는 상황에 맞게 부모 프락시나 원 서버에게 라우팅할 수 있다. 예를 들어 접근 프락시는 필요에 따라 요청을 캐시 프락시나 압축 프락시에 보낼 수 있다.

동적 부모 선택의 몇 가지 예를 들면 다음과 같다.

- 부하 균형 (부모들의 작업량 수준에 근거)
- 지리적 인접성에 근거한 라우팅
- 프로토콜·타입 라우팅 (URI에 근거)
- 유료 서비스 가입자를 위한 라우팅

### 어떻게 프락시가 트래픽을 처리하는가

HTTP 트래픽이 어떻게 프락시로 향하는 길을 찾아내는지 궁금할 수 있다. 다음 네 가지 방법이 있다.

- 클라이언트를 수정
- 네트워크를 수정: 인터셉트 프락시 혹은 투명 프락시(transparent proxy)라고 불린다. 스위칭 장치와 라우팅 장치를 필요로 한다.
- DNS 이름공간을 수정: 대리 프락시는 웹 서버의 이름과 IP 주소를 자신이 직접 사용한다. 그래서 모든 요청은 서버 대신 대리 프락시로 간다.
- 웹 서버를 수정: HTTP 리디렉션 명령을 클라이언트에게 돌려준다.

## 4. 클라이언트 프락시 설정

브라우저에서 프락시를 설정하는 방법은 다음과 같이 여러 가지가 있다.

- 수동 설정
- 브라우저 기본 설정
- 프락시 자동 설정(Proxy auto-configuration, PAC): PAC 파일에 대한 URI를 제공한다.
- WPAD 프락시 발견: PAC 파일을 다운받을 수 있는 설정 서버를 자동으로 찾아주는, 웹 프락시 자동발견 프로토콜(Web Proxy Autodiscovery Protocol, WPAD)을 사용한다.

## 5. 프락시 요청의 미묘한 특징들

### 프락시 URI는 서버 URI와 다르다

웹 서버와 웹 프락시 메시지의 문법은 서로 같지만, 한 가지 예외가 있다.

클라이언트가 웹 서버로 요청을 보낼 때, 요청줄은 다음과 같이 부분 URI를 가진다. 스킴, 호스트, 포트번호가 누락되었다.

```
GET /index.html HTTP/1.0
```

클라이언트가 프락시로 요청을 보낼 때는 다음과 같이 완전한 URI를 갖는다.

```
GET http://www.marys-antiques.com/index.html HTTP/1.0
```

> 오래된 HTTP 버전에서는 부분 URI를 사용해도 됐다. 하지만 HTTP/1.1부터는 프락시와 서버 요청 모두에 완전한 URI를 다룰 것을 요구한다. 그럼에도 오래된 서버들 중에는 부분 URI만을 받아들이는 경우도 있다.

### 가상 호스팅에서 일어나는 같은 문제

프락시의 스킴, 호스트, 포트번호 누락 문제는 가상 호스팅 웹 서버가 직면한 것과 같은 문제다.

이 문제는 각각 다른 방법으로 해결할 수 있다.

- 명시적인 프락시는 요청 메시지가 완전한 URI를 갖게 한다.
- 웹 서버는 호스트와 포트에 대한 정보가 담긴 Host 헤더를 요구한다.

### 인터셉트 프락시는 부분 URI를 받는다

클라이언트의 프락시 사용 여부와 상관없이 클라이언트 트래픽은 여전히 대리 프락시와 인터셉트 프락시를 지날 수 있다. 두 가지 경우 모두, 클라이언트는 완전한 URI를 보내지 않을 것이다.

- 대리 프락시는 원 서버의 호스트 명과 IP 주소를 사용해 원 서버를 대신한다.
- 인터셉트 프락시는 클라이언트에서 서버로 가는 트래픽을 가로채기 때문에 부분 URI를 얻게 될 것이다.

### 프락시는 프락시 요청과 서버 요청을 모두 다룰 수 있다

따라서 다목적 프락시 서버는 요청 메시지의 완전한 URI와 부분 URI를 모두 지원해야 한다.

### 전송 중 URI 변경

프락시 서버는 요청 URI의 변경에 매우 신경을 써야 한다.

일반적으로 프락시 서버는 가능한 한 관대하도록 애써야 한다. '프로토콜 경찰'이 되어서는 안 된다.

특히 HTTP 명세는 일반적인 인터셉트 프락시가 URI를 전달할 때 절대 경로를 고쳐 쓰는 것을 금지한다. 유일한 예외는 빈 경로를 `/`로 교체하는 것뿐이다.

### URI 클라이언트 자동확장과 호스트 명 분석(Hostname Resolution)

브라우저는 프락시의 존재 여부에 따라 요청 URI를 다르게 분석한다.

- 프락시 없는 URI 분석: 브라우저는 유효한 호스트 명이 발견될 때까지 다양한 호스트 명의 가능성들을 검색한다.
- 명시적인 프락시를 사용할 때의 URI 분석: 브라우저는 명시적인 프락시가 있는 경우 부분 호스트 명을 자동확장하지 않는다.
- 인터셉트 프락시를 이용한 URI 분석: 브라우저가 죽은 서버의 IP 주소를 탐지할 수 없다.

## 6. 메시지 추적

Via 헤더 필드는 메시지가 지나는 각 중간 노드(프락시와 게이트웨이)의 정보를 나열한다.

```
Via: 1.1 proxy-62.irenes-isp.net, 1.0 cache.joes-hardware.com
```

이 Via 문자열에 따르면 첫 번째 프락시는 HTTP/1.1 프로토콜을 구현했으며 `proxy-62.irenes-isp.net`라 불리고, 두 번째 프락시는 HTTP/1.0 프로토콜을 구현했으며 `cache.joes-hardware.com`으로 불린다.

응답의 Via 헤더는 거의 대부분 요청의 Via 헤더와 반대다.

TRACE 메서드는 프락시 흐름을 디버깅하는데 매우 유용하다.

## 7. 프락시 인증

프락시는 접근 제어 장치로서 제공될 수 있다. HTTP는 사용자에게 유효한 접근 권한 자격을 요구하는 프락시 인증이라는 메커니즘을 정의하고 있다. 제한된 콘텐츠에 대한 요청이 프락시 서버에 도착하면, 프락시 서버는 407 상태 코드와 Proxy-Authenticate 헤더 필드를 반환할 수 있다.

## 8. 프락시 상호운용성

프락시는 자신이 이해할 수 없는 헤더 필드는 반드시 그대로 전달해야 한다.

HTTP OPTIONS 메서드는 서버나 웹 서버의 특정 리소스가 어떤 기능을 지원하는지(메서드) 클라이언트가 알아볼 수 있게 해준다.

Allow 엔터티 헤더 필드는 자원에 대해 지원되는 메서드들이나 서버가 지원하는 모든 메서드를 열거한다.