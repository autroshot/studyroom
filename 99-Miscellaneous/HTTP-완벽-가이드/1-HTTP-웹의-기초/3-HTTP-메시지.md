# 3장 HTTP 메시지

HTTP가 인터넷의 배달원이라면, HTTP 메시지는 무언가를 담아 보내는 소포와 같다.

HTTP 메시지는 HTTP 애플리케이션 간에 주고받는 데이터의 블록들이다.

## 1. 메시지의 흐름

HTTP는 트랜잭션 방향을 표현할 때 인바운드와 아웃바운드라는 용어를 사용한다. 

- 인바운드: 클라이언트 → 서버
- 아웃바운드: 클라이언트 ← 서버

HTTP 메시지는 강물과 같이 흐른다. 요청이나 응답에 관계없이 모든 메시지는 다운스트림으로 흐른다. 예를 들어 클라이언트가 서버에 요청하는 흐름에서 클라이언트는 서버의 업스트림이고, 서버는 클라이언트의 다운스트림이다. 업스트림은 발송자, 다운스트림은 수신자이다. 강물의 상류와 하류에 비유할 수 있다.

## 2. 메시지의 각 부분

![http-메시지-구조](https://github.com/autroshot/studyroom/assets/95019875/e9004611-683b-44f2-8084-df79bc6814b8)

메시지는 시작줄, 헤더 블록, 본문 이렇게 세 부분으로 이루어진다. 시작줄은 이것이 어떤 메시지인지 기술하며, 헤더 블록은 속성을, 본문은 데이터를 담고 있다.

시작줄과 헤더는 그냥 줄 단위로 분리된 아스키 문자열이다. 각 줄은 CRLF로 끝난다.

본문은 단순히 선택적인 데이터 덩어리다. 본문은 텍스트나 이진 데이터를 포함할 수도 있다.

### 메시지 문법

모든 메시지는 요청 메시지나 응답 메시지로 분류된다. 요청과 응답 모두 기본적으로 구조가 같다.

요청 메시지의 형식은 다음과 같다.

```
<메서드> <요청 URL> <버전>
<헤더>

<엔터티 본문>
```

응답 메시지의 형식은 다음과 같다.

```
<버전> <상태 코드> <사유 구절>
<헤더>

<엔터티 본문>
```

### 시작줄

모든 HTTP 메시지는 시작줄로 시작한다. 요청 메시지의 시작줄을 요청줄, 응답 메시지의 시작줄을 응답줄이라고 부른다. 시작줄의 모든 필드는 공백으로 구분된다.

요청줄에는 서버에서 어떤 동작이 일어나야 하는지 설명해주는 메서드와 그 대상을 지칭하는 요청 URL이 들어있다. 그리고 HTTP 버전도 포함한다.

응답줄에는 HTTP 버전, 상태 코드, 상태를 설명하는 사유 구절이 들어있다.

### 헤더

시작줄 다음에는 0개 또는 1개 이상의 HTTP 헤더가 온다. HTTP 헤더 필드는 요청과 응답 메시지에 추가 정보를 더한다. 기본적으로 이름·값 쌍의 목록이다.

## 3. 메서드

GET과 HEAD 메서드는 안전한 메서드(safe method)이다. 요청의 결과로 서버에 어떤 작용도 없다는 의미이다.

HEAD 메서드는 GET에서 엔터티 본문이 빠진 것이다. 서버는 응답으로 헤더만을 돌려준다. HEAD를 사용하면 다음과 같다.

- 리소스를 가져오지 않고도 그에 대해 무엇인가 알아낼 수 있다.
- 상태 코드를 통해, 개체가 존재하는지 확인할 수 있다.
- 헤더를 확인하여 리소스가 변경되었는지 검사할 수 있다.

HEAD 메서드는 반드시 구현되어 있어야 한다. 또한 서버 개발자는 HEAD에 대한 응답으로 반환되는 헤더가 GET으로 얻는 것과 일치함을 보장해야 한다.

TRACE 메서드는 주로 진단을 위해 사용된다. 예를 들어 요청이 의도한 요청·응답 연쇄를 거쳐가는지 검사할 수 있다.

OPTIONS 메서드는 특정 리소스에 대해 어떤 메서드가 지원되는지 물어볼 때 사용한다.

확장 메서드를 다룰 때는 "엄격하게 보내고 관대하게 받아들여라"라는 오랜 규칙을 따르는 것이 가장 좋다.

## 4. 상태 코드

상태 코드는 책이나 웹을 확인한다.

## 5. 헤더

HTTP 헤더는 다음과 같이 분류된다.

- 일반 헤더: 요청과 응답 양쪽에 모두 나타날 수 있음
- 요청 헤더: 요청에 대한 부가 정보
- 응답 헤더: 요청에 대한 부가 정보
- 엔터티 헤더: 본문 크기와 콘텐츠, 혹은 리소스 그 자체를 서술
- 확장 헤더: 명세에 정의되지 않은 새로운 헤더

각 HTTP 헤더는 간단한 문법을 가진다. 이름, 쉼표, 공백(생략 가능), 필드 값, CRLF가 순서대로 온다. 다음은 흔히 쓰이는 헤더의 몇 가지 예이다.

- `Date: Tue, 3 Oct 1997 02:16:03 GMT`
- `Content-length: 15040`
- `Content-type: image/gif`
- `Accept: image/gif, image/jpeg, text/html`

### 일반 헤더

#### 일반 헤더

- `Date`: 메시지가 언제 만들어졌는지에 대한 정보
- `MIME-Version`: 발송자가 사용한 MIME의 버전
- `Transfer-Encoding`: 메시지에 어떤 인코딩이 적용되었는지에 대한 정보

#### 일반 캐시 헤더

- `Cache-Control`: 메시지와 함께 캐시 지시자를 전달할 때 사용

### 요청 헤더

#### 요청 정보 헤더

- `Host`: 필수. 요청의 대상이 되는 서버의 호스트 명과 포트
- `Referer`: 현재의 요청 URI가 들어있었던 문서의 URL
- `User-Agent`: 요청을 보낸 애플리케이션의 이름

#### Accept 관련 헤더

- `Accept`: 보내도 되는 미디어 종류
- `Accept-Charset`: 보내도 되는 문자집합
- `Accept-Encoding`: 보내도 되는 인코딩
- `Accept-Language`: 보내도 되는 언어

#### 조건부 요청 헤더

클라이언트는 서버에게 요청에 응답하기 전에 먼저 조건이 참인지 확인하게 하는 제약을 포함할 수 있다. 앞에 `If` 접두사가 붙는 헤더가 대부분이다.

#### 요청 보안 헤더

HTTP는 자체적으로 요청을 위한 간단한 인증요구/응답 체계를 갖고 있다.

- `Authorization`: 클라이언트가 서버에게 제공하는 인증 그 자체에 대한 정보
- `Cookie`: 클라이언트가 서버에게 토큰을 전달할 때 사용

#### 프락시 요청 헤더

앞에 `Proxy` 접두사가 붙는 헤더가 많다.

### 응답 헤더

#### 응답 정보 헤더

- `Server`: 서버 애플리케이션의 이름과 버전
- `Retry-After`: 리소스가 사용 가능해지는 날짜 혹은 시간

#### 응답 보안 헤더

- `Set-Cookie`: 클라이언트 측에 토큰을 설정

### 엔터티 헤더

요청과 응답 모두 엔터티를 포함할 수 있으므로 엔터티 헤더는 양 타입에 모두 나타날 수 있다.

#### 엔터티 정보 헤더

- `Location`: 엔터티의 새로운 위치(URL)를 알려줄 때 사용. 주로 리디렉트 할 페이지의 URL을 나타냄

#### 콘텐츠 헤더

- `Content-Type`: 본문이 어떤 종류의 객체인지
- `Content-Encoding`: 본문에 적용된 인코딩
- `Content-Language`: 본문의 언어
- `Content-Length`: 본문의 길이
- `Content-Type`: 본문이 어떤 종류의 객체인지

#### 엔터티 캐싱 헤더

- `ETag`: 리소스의 특정 버전에 대한 식별자
- `Expires`: 이 엔터티가 더 이상 유효하지 않는 일시
- `Last-Modified`: 이 엔터티가 변경된 일시