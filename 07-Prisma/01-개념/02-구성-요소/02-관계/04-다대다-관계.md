# 다대다 관계

다대다(m-n) 관계는 관계의 한쪽에 있는 0개 이상의 레코드가 다른 쪽의 0개 이상의 레코드에 연결될 수 있는 관계를 나타낸다.

## 관계형 데이터베이스

관계형 데이터베이스에서 m-n 관계는 일반적으로 관계 테이블을 통해 모델링된다. m-n 관계는 Prisma 스키마에서 명시적이거나 암시적일 수 있다.

### 명시적 다대다 관계

명시적 다대다 관계에서 관계 테이블은 Prisma 스키마에서 모델로 표현되며 쿼리에서 사용할 수 있다. 명시적 다대다 관계는 다음의 세 가지 모델을 정의한다.

- 다대다 관계가 있는 두 모델 (예: `Category`와 `Post`)
- 관계 테이블을 나타내는 하나의 모델. JOIN, 링크, 피벗 테이블으로도 불린다. (예: `CategoriesOnPosts`)

이 예시에서 관계 테이블을 나타내는 모델은 `Post`-`Category` 관계를 설명하는 추가 필드를 정의한다. 이 필드는 누가 카테고리를 할당했는지(`assignedBy`), 카테고리가 언제 할당되었는지(`assignedAt`)를 표현한다.

```tsx
model Post {
  id         Int                 @id @default(autoincrement())
  title      String
  categories CategoriesOnPosts[]
}

model Category {
  id    Int                 @id @default(autoincrement())
  name  String
  posts CategoriesOnPosts[]
}

model CategoriesOnPosts {
  post       Post     @relation(fields: [postId], references: [id])
  postId     Int // 관계 스칼라 필드 (위의 `@relation` 속성에 사용됨)
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId Int // 관계 스칼라 필드 (위의 `@relation` 속성에 사용됨)
  assignedAt DateTime @default(now())
  assignedBy String

  @@id([postId, categoryId])
}
```

밑에 있는 SQL은 다음과 같다.

```sql
CREATE TABLE "Category" (
    id SERIAL PRIMARY KEY
);
CREATE TABLE "Post" (
    id SERIAL PRIMARY KEY
);
-- Relation table + indexes -------------------------------------------------------
CREATE TABLE "CategoriesOnPosts" (
    "categoryId" integer NOT NULL,
    "postId" integer NOT NULL,
    "assignedBy" text NOT NULL
    "assignedAt" timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("categoryId")  REFERENCES "Category"(id),
    FOREIGN KEY ("postId") REFERENCES "Post"(id)
);
CREATE UNIQUE INDEX "CategoriesOnPosts_category_post_unique" ON "CategoriesOnPosts"("categoryId" int4_ops,"postId" int4_ops);
```

#### 명시적 다대다 쿼리

이제 명시적 다대다 관계를 쿼리하는 방법을 알아볼 것이다.

관계 모델을 직접 쿼리(`prisma.categoriesOnPosts(...)`)하거나 중첩 쿼리를 사용할 수 있다. (`Post` -> `CategoriesOnPosts` -> `Category` 또는 다른 경로)

아래의 쿼리는 다음과 같다.

1. `Post`를 생성한다.
2. 카테고리 할당이나 `CategoriesOnPosts`(Bob이 할당, 오늘 할당)을 생성한다.
3. 새로운 `Category`을 생성한다.

```tsx
const createCategory = await prisma.post.create({
  data: {
    title: 'How to be Bob',
    categories: {
      create: [
        {
          assignedBy: 'Bob',
          assignedAt: new Date(),
          category: {
            create: {
              name: 'New category',
            },
          },
        },
      ],
    },
  },
})
```

아래의 쿼리는 다음과 같다.

- 새로운 `Post`를 생성한다.
- 새 카테고리 할당이나 `CategoriesOnPosts`를 생성한다.
- 범주 할당을 기존 카테고리(ID `9`와 `22`)에 연결한다.

```tsx
const assignCategories = await prisma.post.create({
  data: {
    title: 'How to be Bob',
    categories: {
      create: [
        {
          assignedBy: 'Bob',
          assignedAt: new Date(),
          category: {
            connect: {
              id: 9,
            },
          },
        },
        {
          assignedBy: 'Bob',
          assignedAt: new Date(),
          category: {
            connect: {
              id: 22,
            },
          },
        },
      ],
    },
  },
})
```

다음 쿼리는 하나 이상(`some`)의 관련된 `Post` 레코드 제목에 `"Cool stuff"`라는 단어가 포함되어 있고 Bob에 의해 할당된 모든 카테고리를 반환한다.

```tsx
const getAssignments = await prisma.category.findMany({
  where: {
    posts: {
      some: {
        assignedBy: 'Bob',
        post: {
          title: {
            contains: 'Cool stuff',
          },
        },
      },
    },
  },
})
```

다음 쿼리는 Bob이 5개 게시물 중 하나에 할당한 모든 카테고리 할당(`CategoriesOnPosts`) 레코드를 가져온다.

```tsx
const getAssignments = await prisma.categoriesOnPosts.findMany({
  where: {
    assignedBy: 'Bob',
    post: {
      id: {
        in: [9, 4, 10, 12, 22],
      },
    },
  },
})
```

### 암시적 다대다 관계

암시적 다대다 관계는 관계 필드를 관계의 양쪽에 있는 목록으로 정의한다. 관계 테이블은 밑에 있는 데이터베이스에 존재하지만 Prisma에 의해 관리되며 Prisma 스키마에 **명시되지 않는다**. 암시적 관계 테이블은 특정 규칙을 따른다.

암시적 m-n 관계는 다대다 관계에 대한 Prisma Client API를 좀 더 간단하게 만든다. 이는 중첩 쓰기 내부의 중첩 수준이 하나 줄기 때문이다.

다음 예시에는 `Post`와 `Category` 사이에 하나의 암시적 m-n 관계가 있다.

```tsx
model Post {
  id         Int        @id @default(autoincrement())
  categories Category[]
}

model Category {
  id    Int    @id @default(autoincrement())
  posts Post[]
}
```

